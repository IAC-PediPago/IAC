- name: Run Checkov scan and write junitxml (stdout+stderr -> file)
  shell: |
    set -euo pipefail

    echo "==> [checkov] repo_root: {{ repo_root }}"
    echo "==> [checkov] checkov_directory: {{ checkov_directory }}"
    echo "==> [checkov] output_dir: {{ checkov_output_dir }}"
    echo "==> [checkov] output_filename: {{ checkov_output_filename }}"
    echo "==> [checkov] image: {{ checkov_image }}"
    echo "==> [checkov] soft_fail: {{ checkov_soft_fail }}"

    # Validar que el repo_root y el directorio a escanear existen
    if [ ! -d "{{ repo_root }}" ]; then
      echo "ERROR: repo_root no existe: {{ repo_root }}"
      exit 1
    fi

    if [ ! -d "{{ repo_root }}/{{ checkov_directory }}" ]; then
      echo "ERROR: No existe el directorio a escanear: {{ repo_root }}/{{ checkov_directory }}"
      echo "Contenido de repo_root:"
      ls -lah "{{ repo_root }}" || true
      exit 1
    fi

    OUT_DIR="{{ repo_root }}/{{ checkov_output_dir }}"
    mkdir -p "$OUT_DIR"

    OUT_FILE="$OUT_DIR/{{ checkov_output_filename }}"
    TMP_FILE="${OUT_FILE}.tmp"

    echo "==> [checkov] OUT_DIR: $OUT_DIR"
    echo "==> [checkov] OUT_FILE: $OUT_FILE"

    # Ejecutar checkov y guardar TODO (stdout+stderr) en un tmp
    docker run --rm \
      -v "{{ repo_root }}:/tf" \
      --workdir /tf \
      {{ checkov_image }} \
      --directory /tf/{{ checkov_directory }} \
      -o junitxml \
      {{ '--soft-fail' if checkov_soft_fail | bool else '' }} \
      > "$TMP_FILE" 2>&1

    # Validaciones mínimas: que haya salida y que no esté vacío
    if [ ! -s "$TMP_FILE" ]; then
      echo "ERROR: Checkov no generó salida (archivo vacío): $TMP_FILE"
      exit 1
    fi

    # Si la salida trae logs + xml, nos quedamos desde el primer <testsuite... o <testsuites...
    awk 'BEGIN{p=0} /<testsuites|<testsuite/{p=1} {if(p) print}' "$TMP_FILE" > "$OUT_FILE"

    if [ ! -s "$OUT_FILE" ]; then
      echo "ERROR: No se detectó XML JUnit dentro de la salida de Checkov."
      echo "Primeras 200 líneas de salida cruda:"
      head -n 200 "$TMP_FILE" || true
      exit 1
    fi

    echo "OK: Reporte generado -> $OUT_FILE"
    ls -lah "$OUT_DIR"
    echo "==> [checkov] Primeras 20 líneas del XML:"
    head -n 20 "$OUT_FILE" || true
  args:
    executable: /bin/bash
    chdir: "{{ repo_root }}"
