- name: Run Checkov scan and write junitxml (stdout+stderr -> file)
  shell: |
    set -euo pipefail

    OUT_DIR="{{ repo_root }}/{{ checkov_output_dir }}"
    mkdir -p "$OUT_DIR"

    OUT_FILE="$OUT_DIR/{{ checkov_output_filename }}"
    TMP_FILE="${OUT_FILE}.tmp"

    echo "==> [checkov] repo_root: {{ repo_root }}"
    echo "==> [checkov] checkov_directory: {{ checkov_directory }}"

    # Go-template de docker inspect (ESCAPADO para que Ansible/Jinja no lo procese)
    DOCKER_MOUNT_TPL='{% raw %}{{ range .Mounts }}{{ if eq .Destination "/var/jenkins_home" }}{{ .Name }}{{ end }}{{ end }}{% endraw %}'

    # Detectar el volumen que monta /var/jenkins_home (solo si estamos dentro del contenedor Jenkins)
    JENKINS_VOL="$(docker inspect -f "$DOCKER_MOUNT_TPL" "$HOSTNAME" 2>/dev/null || true)"

    if [ -n "$JENKINS_VOL" ]; then
      echo "==> [checkov] Detectado volumen Jenkins: $JENKINS_VOL"

      # Convertir repo_root a path relativo dentro de /var/jenkins_home
      REPO_REL="{{ repo_root }}"
      REPO_REL="${REPO_REL#/var/jenkins_home/}"

      CONTAINER_REPO="/tf/${REPO_REL}"
      SCAN_DIR="${CONTAINER_REPO}/{{ checkov_directory }}"

      echo "==> [checkov] SCAN_DIR (en contenedor): $SCAN_DIR"

      docker run --rm \
        -v "${JENKINS_VOL}:/tf" \
        --workdir "$CONTAINER_REPO" \
        {{ checkov_image }} \
        --directory "$SCAN_DIR" \
        -o junitxml \
        {{ '--soft-fail' if checkov_soft_fail | bool else '' }} \
        > "$TMP_FILE" 2>&1
    else
      echo "==> [checkov] No se detectó volumen Jenkins (modo local). Usando bind-mount."
      docker run --rm \
        -v "{{ repo_root }}:/tf" \
        --workdir /tf \
        {{ checkov_image }} \
        --directory /tf/{{ checkov_directory }} \
        -o junitxml \
        {{ '--soft-fail' if checkov_soft_fail | bool else '' }} \
        > "$TMP_FILE" 2>&1
    fi

    if [ ! -s "$TMP_FILE" ]; then
      echo "ERROR: Checkov no generó salida (archivo vacío): $TMP_FILE"
      exit 1
    fi

    awk 'BEGIN{p=0} /<testsuites|<testsuite/{p=1} {if(p) print}' "$TMP_FILE" > "$OUT_FILE"

    if [ ! -s "$OUT_FILE" ]; then
      echo "ERROR: No se detectó XML JUnit dentro de la salida de Checkov."
      echo "Primeras 200 líneas de salida cruda:"
      head -n 200 "$TMP_FILE" || true
      exit 1
    fi

    echo "OK: Reporte generado -> $OUT_FILE"
    ls -lah "$OUT_DIR"
    echo "==> [checkov] Primeras 10 líneas:"
    head -n 10 "$OUT_FILE" || true
  args:
    executable: /bin/bash
    chdir: "{{ repo_root }}"