- name: Write backend.hcl (remote state)
  copy:
    dest: "{{ tf_working_dir }}/backend.hcl"
    content: |
      bucket         = "{{ tf_backend_bucket }}"
      key            = "{{ tf_backend_key }}"
      region         = "{{ tf_backend_region }}"
      dynamodb_table = "{{ tf_backend_dynamodb_table }}"
      encrypt        = {{ tf_backend_encrypt | bool | lower }}

- name: Terraform init (reconfigure backend)
  command: terraform init -input=false -reconfigure -backend-config=backend.hcl
  args:
    chdir: "{{ tf_working_dir }}"
  environment:
    TF_IN_AUTOMATION: "true"
    TF_INPUT: "0"

# Ojo: state list puede fallar si el state aún no existe (rc=1).
# Lo dejamos "soft" para que no rompa el pipeline en ambientes nuevos.
- name: Terraform state list (sanity check)
  command: terraform state list
  args:
    chdir: "{{ tf_working_dir }}"
  register: state_list
  failed_when: false
  changed_when: false
  environment:
    TF_IN_AUTOMATION: "true"
    TF_INPUT: "0"

- name: Show state list
  debug:
    var: state_list.stdout_lines

# ✅ Evitar rutas duplicadas: si defaults trae path completo, tomamos basename
- name: Normalize plan output paths
  set_fact:
    tf_plan_file_rel: "{{ tf_plan_file | basename }}"
    tf_plan_txt_rel: "{{ tf_plan_txt | basename }}"

# Clave: permitir rc 0 (sin cambios) y rc 2 (hay cambios)
# y fallar solo si rc es otro valor.
- name: Terraform plan (binary) - allow detailed exit codes
  command: terraform plan -input=false -detailed-exitcode -out "{{ tf_plan_file_rel }}"
  args:
    chdir: "{{ tf_working_dir }}"
  register: tf_plan
  failed_when: tf_plan.rc not in [0, 2]
  changed_when: tf_plan.rc == 2
  environment:
    TF_IN_AUTOMATION: "true"
    TF_INPUT: "0"

- name: Set fact if plan has changes
  set_fact:
    tf_plan_has_changes: "{{ tf_plan.rc == 2 }}"

# ✅ Validación clara: si no se generó el plan, falla con mensaje entendible
- name: Check plan file exists
  stat:
    path: "{{ tf_working_dir }}/{{ tf_plan_file_rel }}"
  register: plan_stat

- name: Fail if plan file was not generated
  fail:
    msg: >-
      Plan file not found: {{ tf_working_dir }}/{{ tf_plan_file_rel }}.
      (tf_working_dir={{ tf_working_dir }}, tf_plan_file={{ tf_plan_file }})
  when: not plan_stat.stat.exists

- name: Terraform show (human-readable)
  command: terraform show -no-color "{{ tf_plan_file_rel }}"
  args:
    chdir: "{{ tf_working_dir }}"
  register: plan_out
  failed_when: plan_out.rc != 0
  changed_when: false
  environment:
    TF_IN_AUTOMATION: "true"
    TF_INPUT: "0"

- name: Write plan.txt
  copy:
    content: "{{ plan_out.stdout }}"
    dest: "{{ tf_working_dir }}/{{ tf_plan_txt_rel }}"

- name: Plan summary
  debug:
    msg: >-
      Terraform plan finished. Changes detected={{ tf_plan_has_changes }}
      (rc={{ tf_plan.rc }}). Plan saved to {{ tf_working_dir }}/{{ tf_plan_txt_rel }}.